---
- name: Ensure .config directory exists
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.config"
    state: directory
    mode: "0755"
  when: ansible_distribution == 'Ubuntu'

- name: Check if .bashrc exists
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.bashrc"
  register: bashrc_stat
  when: ansible_distribution == 'Ubuntu'

- name: Create .bashrc if it doesn't exist
  ansible.builtin.copy:
    content: source $HOME/.config/.termrc
    dest: "{{ ansible_user_dir }}/.bashrc"
    mode: "0644"
  when:
    - ansible_distribution == 'Ubuntu'
    - not bashrc_stat.stat.exists

- name: Check if source line already exists
  ansible.builtin.command: grep -Fxq "source $HOME/.config/.termrc" "{{ ansible_user_dir }}/.bashrc"
  register: grep_result
  changed_when: false
  failed_when: false
  when:
    - ansible_distribution == 'Ubuntu'
    - bashrc_stat.stat.exists

- name: Add source line to existing .bashrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_user_dir }}/.bashrc"
    line: source $HOME/.config/.termrc
    state: present
  when:
    - ansible_distribution == 'Ubuntu'
    - bashrc_stat.stat.exists
    - grep_result.rc != 0 # Only add line if grep didn't find it

- name: Set Bash config path
  ansible.builtin.set_fact:
    config_path: "{{ ansible_user_dir }}/.config"
  when: ansible_distribution == 'Ubuntu'

- name: Copy Bash config files
  ansible.builtin.include_tasks: roles/common_tasks/tasks/copy_configs.yml
